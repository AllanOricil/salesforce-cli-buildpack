#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

START_TIME=$SECONDS

# set -x            # debug every command
set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
set -o nounset    # fail on unset variables
unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps

### Configure directories
CLI_PATH="/tmp/cli"
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

### Create temp folder
mkdir /tmp/cli

### Execute commands
echo ""
echo "-----> \e[38;5;104mWelcome to sfdx-buildpack!\e[0m"
echo ""
echo "       Run install command for Salesforce CLI"
"./sfdx/install" &>/dev/null
echo "       Set path for Salesforce CLI ($CLI_PATH)"
export PATH=$CLI_PATH:$PATH
echo "       Update Salesforce CLI"
sfdx update &>/dev/null
echo "       Check Salesforce CLI plugins"
PLUGINS=$(sfdx plugins)
echo "       Plugin version: $PLUGINS"
echo ""
echo "-----> \e[38;5;104mDONE!\e[0m Completed in $(($SECONDS - $START_TIME))s"
echo ""
exit 0